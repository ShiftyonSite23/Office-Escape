<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Office Escape — Isometric Starter</title>
<style>
  :root {
    --bg:#0e1420;
    --panel:#0a0f19;
    --grid-dark:#0f1a2b;
    --grid-mid:#12223a;
    --grid-lite:#1a3558;
    --ink:#e7eefc;
    --accent:#58e0ff;
    --danger:#ff5a67;
    --ok:#6fff9b;
    --desk:#a57236;
    --wall:#bfc7d6;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:600 16px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px 10px 90px;}
  h1{margin:.4rem 0 .2rem;font-size:clamp(18px,4vw,26px);letter-spacing:.3px}
  #hud{font:600 14px/1 ui-monospace,Consolas,monospace;color:#96a3ba;opacity:.9}
  canvas{background:linear-gradient(160deg,var(--grid-dark),var(--grid-mid));border:2px solid #1e2c46;border-radius:10px;max-width:100%;touch-action:none}
  /* Touch controls */
  .pad{position:fixed;inset:auto 0 10px 0;display:flex;justify-content:center;gap:18px;pointer-events:none}
  .dpad,.act{pointer-events:auto;display:grid;place-items:center;background:var(--panel);border:1px solid #1e2c46;border-radius:14px;padding:8px}
  .dpad{grid-template-areas:
    ". up ."
    "left . right"
    ". down .";
    gap:8px}
  .btn{width:64px;height:64px;border-radius:12px;background:#0f1726;border:1px solid #263656;display:grid;place-items:center;user-select:none}
  .btn:active{transform:translateY(1px);filter:brightness(1.1)}
  .btn svg{width:28px;height:28px;opacity:.9;fill:#cfe6ff}
  .act{display:flex;align-items:center;gap:10px}
  .act .btn{width:84px;height:84px;background:#1a0f13;border-color:#4b2331}
  .pill{position:fixed;top:8px;left:8px;font:700 12px/1 ui-monospace;padding:6px 8px;border-radius:999px;background:#0d1524;border:1px solid #243755;opacity:.92}
  @media (min-width:900px){ .pad{bottom:16px} .btn{width:60px;height:60px} .act .btn{width:76px;height:76px} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Office Escape — Isometric Starter</h1>
    <div id="hud">Coffee: 0 • HP: <span id="hp">6</span> • <span id="dbg">fps:… pos:…</span></div>
    <canvas id="game" width="900" height="600" aria-label="Game canvas"></canvas>
  </div>

  <div class="pad" aria-hidden="true">
    <div class="dpad">
      <div style="grid-area: up"   class="btn" data-btn="up"   title="Up">
        <svg viewBox="0 0 24 24"><path d="M12 5l7 7-1.4 1.4L13 9.8V19h-2V9.8L6.4 13.4 5 12z"/></svg>
      </div>
      <div style="grid-area: left" class="btn" data-btn="left" title="Left">
        <svg viewBox="0 0 24 24"><path d="M5 12l7-7 1.4 1.4L9.8 11H19v2H9.8l3.6 4.6L12 19z"/></svg>
      </div>
      <div style="grid-area: right" class="btn" data-btn="right" title="Right">
        <svg viewBox="0 0 24 24"><path d="M19 12l-7 7-1.4-1.4L14.2 13H5v-2h9.2L10.6 6.4 12 5z"/></svg>
      </div>
      <div style="grid-area: down" class="btn" data-btn="down" title="Down">
        <svg viewBox="0 0 24 24"><path d="M12 19l-7-7 1.4-1.4L11 14.2V5h2v9.2l4.6-3.6L19 12z"/></svg>
      </div>
    </div>
    <div class="act">
      <div class="btn" data-btn="attack" title="Attack">
        <svg viewBox="0 0 24 24"><path d="M3 13l8-8 8 8-1.4 1.4L11 6.8V21H9V6.8L4.4 14.4 3 13z"/></svg>
      </div>
    </div>
  </div>

  <div class="pill" id="pill">debug: on (press ~ to toggle)</div>

<script>
/*==========================================================
  Office Escape — Isometric Starter
  - Grid isometric renderer
  - Player with keyboard + touch controls
  - Two patrolling co-worker enemies
  - Solid collisions + HP + i-frames
==========================================================*/

const C = document.getElementById('game');
const X = C.getContext('2d');
const HUD_HP = document.getElementById('hp');
const HUD_DBG = document.getElementById('dbg');
const PILL = document.getElementById('pill');

let DEBUG = true;
document.addEventListener('keydown', e=>{
  if (e.key === '`' || e.key === '~'){ DEBUG = !DEBUG; PILL.textContent = 'debug: ' + (DEBUG? 'on':'off'); PILL.style.display = DEBUG? 'block':'none'; }
});

// ---------- World / Iso ----------
const TILE = 32;              // world grid size
const ISO_W = 36;             // tiles across (world)
const ISO_H = 24;             // tiles down (world)
const CAM = { x: ISO_W*TILE/2, y: ISO_H*TILE/2, zoom: 1 };  // we center, then pan with player

// simple office layout: 0 = floor, 1 = wall
const world = Array.from({length:ISO_H}, (_,y)=>
  Array.from({length:ISO_W}, (_,x)=>0)
);

// sprinkle cubicle walls as rectangles
function addRect(x,y,w,h){
  for(let j=0;j<h;j++) for(let i=0;i<w;i++){
    const xx = x+i, yy=y+j;
    if(xx>0&&xx<ISO_W&&yy>0&&yy<ISO_H){
      if(i===0||j===0||i===w-1||j===h-1) world[yy][xx]=1;
    }
  }
}
// a few cubicles
addRect(4,4,6,5);
addRect(14,6,7,5);
addRect(24,4,6,5);
addRect(8,14,8,6);
addRect(22,13,9,7);
addRect(5,19,7,4);

// ---------- Entities ----------
const player = {
  x: 6.5*TILE, y: 6.5*TILE, w: 18, h: 22, spd: 2.2,
  hp: 6, inv: 0, dir: 1, attacking: 0
};

const enemies = [
  patrolEnemy(20.5*TILE, 7.5*TILE, [[20.5,7.5],[28.5,7.5],[28.5,11.5],[20.5,11.5]]),
  patrolEnemy(10.5*TILE, 18.5*TILE, [[10.5,18.5],[16.5,18.5],[16.5,15.5],[10.5,15.5]])
];

function patrolEnemy(px,py, waypoints){
  return {
    x:px, y:py, w:18, h:22, spd:1.6, dir:1, i:0, t:0, wp:waypoints.map(([gx,gy])=>({x:gx*TILE,y:gy*TILE})),
    hitFlash:0, alive:true
  };
}

// ---------- Input ----------
const keys = {left:false,right:false,up:false,down:false,attack:false};
addEventListener('keydown',e=>{
  if(e.repeat) return;
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=true;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=true;
  if(e.key===' '||e.key==='Enter') keys.attack=true;
});
addEventListener('keyup',e=>{
  if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
  if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
  if(e.key==='ArrowUp'||e.key==='w') keys.up=false;
  if(e.key==='ArrowDown'||e.key==='s') keys.down=false;
  if(e.key===' '||e.key==='Enter') keys.attack=false;
});

// touch buttons
document.querySelectorAll('[data-btn]').forEach(el=>{
  const k = el.dataset.btn;
  const on = ()=> keys[k]=true;
  const off= ()=> keys[k]=false;
  el.addEventListener('touchstart', e=>{e.preventDefault(); on();},{passive:false});
  el.addEventListener('touchend',   e=>{e.preventDefault(); off();},{passive:false});
  el.addEventListener('mousedown', on);
  el.addEventListener('mouseup', off);
  el.addEventListener('mouseleave', off);
});

// ---------- Helpers ----------
function isoProject(wx, wy){
  // classic 2:1 iso
  const ix = (wx - wy) * 0.5;
  const iy = (wx + wy) * 0.25;
  return { x: C.width/2 + (ix - CAM.x*0.5 + CAM.y*0.5), y: C.height*0.58 + (iy - CAM.x*0.25 - CAM.y*0.25) };
}
function rectsOverlap(a,b){ return Math.abs(a.x-b.x)<(a.w+b.w)/2 && Math.abs(a.y-b.y)<(a.h+b.h)/2; }
function tileAt(px,py){
  const tx = Math.floor(px/TILE), ty = Math.floor(py/TILE);
  if(ty<0||ty>=ISO_H||tx<0||tx>=ISO_W) return 1; // outside = wall
  return world[ty][tx];
}
function collideMove(e, dx, dy){
  // attempt move with simple AABB vs tile walls
  let nx = e.x + dx, ny = e.y + dy;
  // sample feet and sides
  const sample = (sx,sy)=> tileAt(sx,sy)===1;
  // X axis
  if(dx!==0){
    const sx = nx + Math.sign(dx)*(e.w/2-1);
    const top = e.y - (e.h/2) + 4, bottom = e.y + (e.h/2) - 2;
    if (sample(sx, top) || sample(sx, bottom)) { nx = e.x; }
  }
  // Y axis
  if(dy!==0){
    const sy = ny + Math.sign(dy)*(e.h/2-1);
    const left = e.x - (e.w/2) + 4, right = e.x + (e.w/2) - 4;
    if (sample(left, sy) || sample(right, sy)) { ny = e.y; }
  }
  e.x = nx; e.y = ny;
}

// ---------- Update / Draw ----------
let last=0, acc=0, fps=60;
function loop(t){
  const dt = (t-last)||16; last=t; acc = 0.001*dt;
  fps = Math.round(1000/dt);

  update(acc);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  // player input (iso directions)
  let vx=0, vy=0;
  const speed = player.spd * (keys.up&&keys.down? 0.8:1);
  if(keys.left)  { vx -= speed; vy += speed; player.dir=-1; }
  if(keys.right) { vx += speed; vy -= speed; player.dir= 1; }
  if(keys.up)    { vx -= speed; vy -= speed; }
  if(keys.down)  { vx += speed; vy += speed; }

  collideMove(player, vx, 0);
  collideMove(player, 0, vy);

  if(keys.attack && player.attacking<=0){ player.attacking = 0.18; }
  if(player.attacking>0) player.attacking -= dt;

  if(player.inv>0) player.inv -= dt;

  // enemies patrol
  for(const e of enemies){
    if(!e.alive) continue;
    const wp = e.wp[e.i];
    const dx = wp.x - e.x, dy = wp.y - e.y;
    const d = Math.hypot(dx,dy);
    if(d<1){ e.i=(e.i+1)%e.wp.length; }
    else {
      const ux = (dx/d)*e.spd, uy=(dy/d)*e.spd;
      e.dir = ux>=0 ? 1 : -1;
      collideMove(e, ux, 0);
      collideMove(e, 0, uy);
    }
    if(e.hitFlash>0) e.hitFlash -= dt;
  }

  // combat (short melee in front of player)
  if(player.attacking>0){
    const reach = 18;
    const hit = { x: player.x + player.dir*reach, y: player.y, w:18, h:20 };
    for(const e of enemies){
      if(!e.alive) continue;
      if(rectsOverlap({x:hit.x,y:hit.y,w:hit.w,h:hit.h},{x:e.x,y:e.y,w:e.w,h:e.h})){
        e.hitFlash = 0.2;
        e.alive = false;
      }
    }
  }

  // enemy touches player
  for(const e of enemies){
    if(!e.alive) continue;
    if(rectsOverlap(player,e) && player.inv<=0){
      player.hp = Math.max(0, player.hp-1);
      HUD_HP.textContent = player.hp;
      player.inv = 0.9;
      // tiny knockback
      collideMove(player, (player.x-e.x)*0.5, (player.y-e.y)*0.5);
    }
  }

  // camera follows player (in world space)
  CAM.x = player.x; CAM.y = player.y;

  // HUD
  if(DEBUG) HUD_DBG.textContent = `fps:${fps} pos:${(player.x/TILE).toFixed(1)},${(player.y/TILE).toFixed(1)}`;
}

function draw(){
  X.clearRect(0,0,C.width,C.height);

  // draw tile grid
  for(let y=0;y<ISO_H;y++){
    for(let x=0;x<ISO_W;x++){
      const wx = x*TILE + TILE/2, wy = y*TILE + TILE/2;
      const p = isoProject(wx,wy);
      const w = TILE, h=TILE;
      // diamond
      X.beginPath();
      X.moveTo(p.x, p.y - h*0.25);
      X.lineTo(p.x + w*0.5, p.y);
      X.lineTo(p.x, p.y + h*0.25);
      X.lineTo(p.x - w*0.5, p.y);
      X.closePath();
      X.fillStyle = ((x+y)&1)? '#11263f':'#0f2036';
      X.fill();

      // walls
      if(world[y][x]===1){
        X.fillStyle = '#c7d2e3';
        X.strokeStyle = '#7a879a';
        X.lineWidth = 1;
        X.fill();
        X.stroke();
      }
    }
  }

  // decorative desks (simple rectangles near some cubicles)
  drawDesk(6,7); drawDesk(15,8); drawDesk(25,6);
  drawDesk(11,16); drawDesk(24,16);

  // enemies
  for(const e of enemies){
    if(!e.alive) continue;
    drawDude(e.x,e.y, e.dir, e.hitFlash>0 ? 'enemyHit' : 'enemy');
  }

  // player
  drawDude(player.x, player.y, player.dir, player.inv>0 ? 'inv' : (player.attacking>0?'swing':'player'));

  // swing arc
  if(player.attacking>0){
    const reach = 18;
    const p = isoProject(player.x + player.dir*reach, player.y);
    X.fillStyle = 'rgba(255,90,103,.25)';
    X.beginPath(); X.arc(p.x, p.y-10, 14, 0, Math.PI*2); X.fill();
  }
}

function drawDesk(tx,ty){
  const wx = tx*TILE + TILE/2, wy = ty*TILE + TILE/2;
  const p = isoProject(wx,wy);
  // top
  X.fillStyle = '#a57236';
  X.beginPath();
  X.moveTo(p.x-24,p.y-6);
  X.lineTo(p.x,p.y-18);
  X.lineTo(p.x+24,p.y-6);
  X.lineTo(p.x,p.y+6);
  X.closePath();
  X.fill();
  // legs
  X.strokeStyle = '#6b4520'; X.lineWidth=3;
  X.beginPath();
  X.moveTo(p.x-16,p.y+6); X.lineTo(p.x-16,p.y+16);
  X.moveTo(p.x+16,p.y+6); X.lineTo(p.x+16,p.y+16);
  X.stroke();
}

function drawDude(wx,wy, dir, mode){
  const p = isoProject(wx,wy);
  // shadow
  X.fillStyle = 'rgba(0,0,0,.35)';
  X.beginPath(); X.ellipse(p.x,p.y,12,6,0,0,Math.PI*2); X.fill();

  // body
  let shirt='#57a7ff', tie='#f45', head='#f1d6b8';
  if(mode==='enemy'){ shirt='#cbd5e1'; tie='#7a93b2'; }
  if(mode==='enemyHit'){ shirt='#ffd3d8'; tie='#ff5a67'; }
  if(mode==='inv'){ shirt='#8bd9ff'; }

  // torso
  X.fillStyle = shirt;
  X.fillRect(p.x-8, p.y-26, 16, 18);
  // head
  X.fillStyle = head; X.fillRect(p.x-7, p.y-38, 14, 12);
  // tie / badge
  X.fillStyle = tie; X.fillRect(p.x-2, p.y-22, 4, 10);
  // face pixel
  X.fillStyle = '#111'; X.fillRect(p.x-5 + (dir>0?4:0), p.y-34, 3,2);
}

</script>
</body>
</html>
